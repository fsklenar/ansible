---
- name: Configure KVM and networking on salaserver
  hosts: salaserver
  become: true
  vars:
    my_pass: "{{ lookup('password', '/tmp/passwordfile length=15 chars=ascii_letters') }}"
  vars_files:
    - ../vars/common_vars.yaml

  tasks:
    - name: Update apt and install required KVM packages
      ansible.builtin.apt:
        pkg:
          - qemu-kvm
          - virtinst
          - libvirt-clients
          - bridge-utils
          - libvirt-daemon-system
          - guestfs-tools
          - virtiofsd
          - docker-compose
        state: present
        update_cache: true

    - name: Copy shutdown script
      ansible.builtin.copy:
        src: vars/shut.sh
        dest: /usr/local/bin/shut
        mode: '0750'
        group: root
        owner: "{{ server_username }}"

    - name: Create /srv/data folder
      ansible.builtin.file:
        path: /srv/data
        state: directory
        mode: '0750'
        owner: "{{ server_username }}"
        group: "libvirt-qemu"

    - name: Create /srv/data/iso folder
      ansible.builtin.file:
        path: /srv/data/iso
        state: directory
        mode: '0770'
        owner: "{{ server_username }}"
        group: "{{ ansible_username }}"

    - name: Create /srv/data/img folder
      ansible.builtin.file:
        path: /srv/data/img
        state: directory
        mode: '0770'
        owner: "{{ server_username }}"
        group: "libvirt-qemu"

    - name: Create /srv/data/virtiofs folder for sharing into VMs as Persistent Volume - prometheus
      ansible.builtin.file:
        path: /srv/data/virtiofs/prometheus
        state: directory
        mode: '0777'
        owner: "libvirt-qemu"
        group: "{{ server_username }}"

    - name: Create /srv/data/virtiofs folder for sharing into VMs as Persistent Volume - grafana
      ansible.builtin.file:
        path: /srv/data/virtiofs/grafana
        state: directory
        mode: '0777'
        owner: "libvirt-qemu"
        group: "{{ server_username }}"

    - name: Create /srv/data/virtiofs folder for sharing into VMs as Persistent Volume - wordpress
      ansible.builtin.file:
        path: /srv/data/virtiofs/wordpress
        state: directory
        mode: '0777'
        owner: "libvirt-qemu"
        group: "{{ server_username }}"

    - name: Create /srv/data/virtiofs folder for sharing into VMs as Persistent Volume - mysql
      ansible.builtin.file:
        path: /srv/data/virtiofs/mysql
        state: directory
        mode: '0777'
        owner: "libvirt-qemu"
        group: "{{ server_username }}"

    - name: Create /srv/data/virtiofs folder for sharing into VMs as Persistent Volume - elasticsearch
      ansible.builtin.file:
        path: /srv/data/virtiofs/elastic
        state: directory
        mode: '0777'
        owner: "libvirt-qemu"
        group: "{{ server_username }}"

    - name: Create /srv/data/virtiofs folder for sharing into VMs as Persistent Volume - immich-psql
      ansible.builtin.file:
        path: /srv/data/virtiofs/immich-psql
        state: directory
        mode: '0777'
        owner: "libvirt-qemu"
        group: "{{ server_username }}"

    - name: Create /srv/data/virtiofs folder for sharing into VMs as Persistent Volume - gitlab
      ansible.builtin.file:
        path: /srv/data/virtiofs/gitlab
        state: directory
        mode: '0777'
        owner: "libvirt-qemu"
        group: "{{ server_username }}"


    - name: Check if netplan bridge file exists
      ansible.builtin.stat:
        path: "/etc/netplan/01-bridge.yaml"
      register: bridge_file_status

    - name: Configure bridge network if not present
      when: not bridge_file_status.stat.exists
      block:

        - name: Create bridge network
          ansible.builtin.copy:
            src: vars/01-bridge.yaml
            dest: /etc/netplan/
            mode: '0600'
            group: root
            owner: root

        - name: Check if netplan bridge file exists v2
          ansible.builtin.stat:
            path: "/etc/netplan/01-bridge.yaml"
          register: bridge_file_v2_status

        - name: Delete common network yaml file
          ansible.builtin.file:
            path: /etc/netplan/50-cloud-init.yaml
            state: absent
          when: bridge_file_v2_status.stat.exists

        - name: Netplan apply
          ansible.builtin.shell: |
            sudo netplan apply
            sleep 30

    - name: Copy bridger xml file
      ansible.builtin.copy: 
        src: vars/02-kvm-bridger-network.yaml
        dest: /tmp/
        mode: '0600'
        group: root
        owner: root

    - name: Create bridger network for KVM
      ansible.builtin.shell: |
        sudo virsh net-define /tmp/02-kvm-bridger-network.yaml
        sudo virsh net-start bridged-network
        sudo virsh net-autostart bridged-network
